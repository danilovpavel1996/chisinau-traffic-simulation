# ChiÈ™inÄƒu Traffic Simulation

City-scale traffic simulation of ChiÈ™inÄƒu, Moldova using SUMO v1.26.0.
Visualized with deck.gl in a standalone HTML dashboard.

---

## ğŸ—ºï¸ What This Is

A full-day (00:00â€“24:00) microscopic traffic simulation of ChiÈ™inÄƒu with:
- **150,000+ vehicle trips** across 8 districts
- **265 signalized intersections** with realistic timing
- **2,763 road segments** with congestion coloring
- **Morning & evening peak** calibrated against Google Maps ground truth
- Interactive deck.gl visualization with live stats, congestion layers, traffic lights

---

## ğŸ“Š Calibration Status (Feb 2026)

Ground truth from Google Maps predicted travel times:

| Corridor | Google Maps 08:00 | Simulation | Status |
|----------|-------------------|------------|--------|
| Bd. È˜tefan cel Mare | 8.8 km/h | 14 km/h | âš ï¸ improving |
| Calea IeÈ™ilor â†’ Centru | 8.6 km/h | 16 km/h | âš ï¸ improving |
| Botanica â†’ PrimÄƒrie | 7.1 km/h | ~14 km/h | âš ï¸ improving |
| MunceÈ™ti â†’ Bd. È˜tefan | 12.5 km/h | ~15 km/h | âœ… close |

| Version | Vehicles/day | Mean Speed Ratio | Notes |
|---------|-------------|-----------------|-------|
| v1 baseline | 50,000 | 0.90 | nearly free flow, unrealistic |
| v2 calibrated | 150,000 | 0.485 | realistic congestion, 3x demand scale |

---

## ğŸš€ Quick Start â€” Full Pipeline

### Prerequisites
```bash
pip install sumolib pandas numpy
# SUMO v1.26.0 must be installed and on PATH
```

### Step 1 â€” OSM Network (if not present)
```bash
netconvert --osm-files data/osm/chisinau.osm \
  --output-file data/sumo_net/network.net.xml \
  --geometry.remove --roundabouts.guess --ramps.guess \
  --junctions.join --tls.guess-signals --tls.join
```

### Step 2 â€” Scale & Generate Trips
```bash
python3 scale_trips.py        # uses od_matrix_scaled.csv, resamples from original trips
```

### Step 3 â€” Route Assignment
```bash
duarouter \
  --net-file data/sumo_net/network.net.xml \
  --route-files data/demand/trips.trips.xml \
  --output-file data/demand/trips.rou.xml \
  --ignore-errors true --no-warnings true --routing-threads 4
```

### Step 4 â€” Run SUMO Simulation (~25 min)
```bash
sumo -c data/outputs/corridor.sumocfg \
  --fcd-output data/outputs/fcd_full.xml \
  --fcd-output.geo true \
  --fcd-output.period 2 \
  --tripinfo-output data/outputs/tripinfo.xml
```
> âš ï¸ `--fcd-output.period 2` captures roundabout geometry while keeping file ~3-5GB

### Step 5 â€” Post-Process
```bash
python3 postprocess.py    # FCD â†’ edge_congestion.csv + roads_congestion.geojson
python3 make_deckgl.py    # FCD â†’ trips_deckgl.json
```

### Step 6 â€” View
```bash
cd data/outputs && python3 -m http.server 8080
# Open: http://localhost:8080/chisinau_traffic.html
```

---

## âš ï¸ What's Not in This Repo

| File | Size | How to Regenerate |
|------|------|-------------------|
| `data/sumo_net/network.net.xml` | ~298MB | Step 1 above |
| `data/outputs/fcd_full.xml` | ~3-67GB | Step 4 above |
| `data/outputs/edgedata.xml` | ~53MB | generated by SUMO automatically |
| `.venv/` | ~361MB | `python3 -m venv .venv && pip install -r requirements.txt` |

---

## ğŸ“ Key Files

```
data/
  demand/
    od_matrix.csv              # Original OD matrix (8 districts Ã— 96 time bins)
    od_matrix_scaled.csv       # 3x scaled â€” used for calibrated simulation
    trips.trips.xml            # Generated vehicle trips (150k)
    trips.rou.xml              # Routed trips (duarouter output, not in repo)
  outputs/
    chisinau_traffic.html      # â† Main visualization
    roads_congestion.geojson   # Road segments with speed ratios + colors
    edge_congestion.csv        # Per-edge congestion metrics
    trips_deckgl.json          # Vehicle animation waypoints (morning peak)
    traffic_lights.json        # TLS positions and phase states
  sumo_net/
    network.net.xml            # Full SUMO road network (not in repo)

scale_trips.py                 # Demand scaling + trip generation
postprocess.py                 # FCD â†’ congestion outputs
make_deckgl.py                 # FCD â†’ vehicle animation JSON
```

---

## ğŸ—ºï¸ Districts

| District | Trip Templates | Status |
|----------|---------------|--------|
| Centru | âœ… | Full coverage |
| Botanica | âœ… | Full coverage |
| Buiucani | âœ… | Full coverage |
| RÃ¢È™cani | âœ… | Full coverage |
| Sculeni | âœ… | Full coverage |
| Ciocana | âš ï¸ | Bounding box needs expansion â€” see TODO |
| Telecentru | âš ï¸ | Bounding box needs expansion â€” see TODO |
| DurleÈ™ti | âš ï¸ | Bounding box needs expansion â€” see TODO |

---

## ğŸ“‹ TODO

### ğŸ”´ High Priority
- [ ] **Fix district bounding boxes** for Ciocana, Telecentru, DurleÈ™ti in `scale_trips.py`
  - Ciocana: `lon 28.870â€“28.980, lat 46.970â€“47.060`
  - Telecentru: `lon 28.800â€“28.890, lat 46.930â€“47.010`
  - DurleÈ™ti: `lon 28.724â€“28.830, lat 47.000â€“47.088`
- [ ] **Re-run full pipeline** after district fix with `--fcd-output.period 2`
  - Fixes roundabout car behavior (2s resolution captures circular paths)
  - Adds ~50k more trips from the 3 missing districts

### ğŸŸ¡ Medium Priority
- [ ] **Validate vs Google Maps** â€” all corridors should be within 1.5x ground truth
  - If still too fast â†’ scale demand to 4.0x and re-run
- [ ] **Update visualization header** â€” currently shows "50,000 vehicles/day" â†’ fix to 150k
- [ ] **Evening peak visualization** â€” extend trips_deckgl.json to cover 17:00â€“20:00

### ğŸŸ¢ Nice to Have
- [ ] **Tune signal timing** on top congested intersections:
  - Bd. È˜tefan cel Mare Ã— Str. PuÈ™kin (81% congestion ratio)
  - Bd. È˜tefan cel Mare Ã— Calea IeÈ™ilor (78%)
- [ ] **Real OD matrix** from mobile/telecom data
- [ ] **Deploy** visualization to GitHub Pages
